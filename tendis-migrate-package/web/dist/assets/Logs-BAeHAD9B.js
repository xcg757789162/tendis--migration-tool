import{_ as Le,o as Ve,a as De,b as u,c as _,d as t,e as s,w as a,f as p,g as F,t as d,m,y as Fe,F as E,r as O,z as $e,h as I,l as Re,i as z,j as i,k as g,C as Se,E as b}from"./index-aaIhUkFC.js";const ze={class:"logs-view"},Ne={class:"page-header"},je={class:"header-content"},qe={class:"page-title"},Ae={class:"header-actions"},Ee={style:{"font-size":"12px",color:"#409EFF","font-weight":"500"}},Oe={class:"stats-row"},Ie={class:"stat-card"},Te={class:"stat-icon total"},Ue={class:"stat-info"},Be={class:"stat-value"},We={class:"stat-card"},Pe={class:"stat-icon error"},Je={class:"stat-info"},Me={class:"stat-value"},Ge={class:"stat-card"},Ke={class:"stat-icon warn"},He={class:"stat-info"},Qe={class:"stat-value"},Xe={class:"stat-card"},Ye={class:"stat-icon info"},Ze={class:"stat-info"},et={class:"stat-value"},tt={class:"stat-card"},st={class:"stat-icon uptime"},lt={class:"stat-info"},at={class:"stat-value uptime-text"},ot={class:"filter-section"},nt={class:"filter-row"},it={class:"logs-container"},dt={class:"logs-header"},ut={class:"logs-count"},rt={class:"logs-actions"},ct={class:"logs-list"},_t={key:0,class:"empty-state"},vt=["onClick"],pt={class:"log-header"},mt={class:"log-time"},ft={key:0,class:"log-source"},gt={key:1,class:"log-tag request"},kt={key:2,class:"log-tag task"},yt={class:"log-message"},bt={key:0,class:"log-fields"},ht={class:"field-key"},wt={class:"field-value"},Ct={class:"log-actions"},xt={key:0,class:"pagination-wrapper"},Lt={key:0,class:"log-detail"},Vt={class:"detail-section"},Dt={class:"detail-grid"},Ft={class:"detail-item"},$t={class:"value"},Rt={class:"detail-item"},St={class:"detail-item"},zt={class:"value"},Nt={class:"detail-item"},jt={class:"value"},qt={key:0,class:"detail-item"},At={class:"value mono"},Et={key:1,class:"detail-item"},Ot={class:"value mono"},It={class:"detail-section"},Tt={class:"message-box"},Ut={key:0,class:"detail-section"},Bt={class:"fields-json"},Wt={key:1,class:"detail-section"},Pt={class:"stack-trace"},Jt={__name:"Logs",setup(Mt){const L=g(!1),h=g([]),$=g(0),y=g(1),w=g(100),T=g(!1),R=g(!1),c=g(null),N=g([]);let V=null;const C=g({total:0,by_level:{},uptime:"-",memory_mb:0}),r=g({level:"",keyword:"",task_id:"",request_id:""}),D=async()=>{L.value=!0;try{const l={limit:w.value,offset:(y.value-1)*w.value,level:r.value.level,keyword:r.value.keyword,task_id:r.value.task_id,request_id:r.value.request_id},e=await z.getLogs(l);h.value=e.items||[],$.value=e.total||0}catch(l){console.error("Failed to fetch logs:",l)}finally{L.value=!1}},Q=async()=>{try{const l=await z.getLogsStats();C.value=l}catch(l){console.error("Failed to fetch stats:",l)}},X=async()=>{try{const l=await z.getTasks();N.value=l.items||[]}catch(l){console.error("Failed to fetch tasks:",l)}},Y=l=>{const e=N.value.find(v=>v.id===l);return e?`${e.name} (${l.substring(0,8)})`:l.substring(0,8)},S=()=>{D(),Q()},U=()=>{y.value=1,D()},Z=()=>{r.value={level:"",keyword:"",task_id:"",request_id:""},y.value=1,D()},ee=l=>{y.value=l,D()},te=l=>{w.value=l,y.value=1,D()},se=l=>{l?V=setInterval(S,5e3):(clearInterval(V),V=null)},le=async l=>{try{let e=l,v="";l.startsWith("task-")&&(e=l.replace("task-",""),v=r.value.task_id);const n=new URLSearchParams;n.set("format",e),r.value.level&&n.set("level",r.value.level),r.value.keyword&&n.set("keyword",r.value.keyword),v&&n.set("task_id",v);const j=`/api/v1/logs/export?${n.toString()}`,f=document.createElement("a");f.href=j,document.body.appendChild(f),f.click(),document.body.removeChild(f),b.success(v?"任务日志导出成功":"日志导出成功")}catch(e){b.error("导出失败: "+e.message)}},ae=async()=>{try{await z.clearLogs(),b.success("日志已清除"),S()}catch(l){b.error("清除失败: "+l.message)}},oe=l=>{c.value=l,R.value=!0},ne=l=>typeof l=="object"?JSON.stringify(l):String(l),B=l=>{const e=W(l);navigator.clipboard.writeText(e).then(()=>{b.success("已复制到剪贴板")}).catch(()=>{const v=document.createElement("textarea");v.value=e,document.body.appendChild(v),v.select(),document.execCommand("copy"),document.body.removeChild(v),b.success("已复制到剪贴板")})},ie=()=>{const l=h.value.map(W).join(`

`);navigator.clipboard.writeText(l).then(()=>{b.success(`已复制 ${h.value.length} 条日志`)})},W=l=>{let e=`[${l.timestamp}] [${l.level}]`;return l.source&&(e+=` [${l.source}]`),l.request_id&&(e+=` [req:${l.request_id.substring(0,8)}]`),l.task_id&&(e+=` [task:${l.task_id.substring(0,8)}]`),e+=` ${l.message}`,l.fields&&Object.keys(l.fields).length>0&&(e+=`
  Fields: ${JSON.stringify(l.fields)}`),l.stack&&(e+=`
  Stack:
${l.stack}`),e};return Ve(()=>{X(),S()}),De(()=>{V&&clearInterval(V)}),(l,e)=>{var M,G,K;const v=i("Document"),n=i("el-icon"),j=i("Refresh"),f=i("el-button"),de=i("Delete"),ue=i("el-popconfirm"),re=i("Download"),ce=i("ArrowDown"),x=i("el-dropdown-item"),_e=i("el-dropdown-menu"),ve=i("el-dropdown"),pe=i("CircleClose"),me=i("Warning"),fe=i("InfoFilled"),ge=i("Timer"),P=i("Search"),ke=i("el-input"),k=i("el-option"),J=i("el-select"),ye=i("el-checkbox"),q=i("CopyDocument"),be=i("Connection"),he=i("Files"),we=i("el-pagination"),Ce=i("el-dialog"),xe=Se("loading");return u(),_("div",ze,[t("div",Ne,[t("div",je,[t("h1",qe,[s(n,null,{default:a(()=>[s(v)]),_:1}),e[9]||(e[9]=p(" 系统日志 ",-1))]),e[10]||(e[10]=t("p",{class:"page-desc"},"查看、搜索和导出系统运行日志，便于故障排查",-1))]),t("div",Ae,[s(f,{onClick:S,loading:L.value},{default:a(()=>[s(n,null,{default:a(()=>[s(j)]),_:1}),e[11]||(e[11]=p("刷新 ",-1))]),_:1},8,["loading"]),s(ue,{title:"确定要清除所有日志吗？此操作不可恢复！","confirm-button-text":"确定清除","cancel-button-text":"取消",onConfirm:ae},{reference:a(()=>[s(f,{type:"danger",plain:""},{default:a(()=>[s(n,null,{default:a(()=>[s(de)]),_:1}),e[12]||(e[12]=p("清除全部 ",-1))]),_:1})]),_:1}),s(ve,{onCommand:le},{dropdown:a(()=>[s(_e,null,{default:a(()=>[s(x,{command:"text"},{default:a(()=>[...e[14]||(e[14]=[p("导出全部日志 (.txt)",-1)])]),_:1}),s(x,{command:"json"},{default:a(()=>[...e[15]||(e[15]=[p("导出全部日志 (.json)",-1)])]),_:1}),r.value.task_id?(u(),F(x,{key:0,divided:""},{default:a(()=>[t("span",Ee," 当前筛选任务: "+d(Y(r.value.task_id)),1)]),_:1})):m("",!0),r.value.task_id?(u(),F(x,{key:1,command:"task-text"},{default:a(()=>[s(n,null,{default:a(()=>[s(v)]),_:1}),e[16]||(e[16]=p(" 导出当前任务日志 (.txt) ",-1))]),_:1})):m("",!0),r.value.task_id?(u(),F(x,{key:2,command:"task-json"},{default:a(()=>[s(n,null,{default:a(()=>[s(v)]),_:1}),e[17]||(e[17]=p(" 导出当前任务日志 (.json) ",-1))]),_:1})):m("",!0),r.value.task_id?m("",!0):(u(),F(x,{key:3,divided:"",disabled:""},{default:a(()=>[...e[18]||(e[18]=[t("span",{style:{"font-size":"12px",color:"#999"}},"提示: 选择任务后可单独导出",-1)])]),_:1}))]),_:1})]),default:a(()=>[s(f,{type:"primary"},{default:a(()=>[s(n,null,{default:a(()=>[s(re)]),_:1}),e[13]||(e[13]=p("导出日志 ",-1)),s(n,{class:"el-icon--right"},{default:a(()=>[s(ce)]),_:1})]),_:1})]),_:1})])]),t("div",Oe,[t("div",Ie,[t("div",Te,[s(n,null,{default:a(()=>[s(v)]),_:1})]),t("div",Ue,[t("span",Be,d(C.value.total),1),e[19]||(e[19]=t("span",{class:"stat-label"},"总日志数",-1))])]),t("div",We,[t("div",Pe,[s(n,null,{default:a(()=>[s(pe)]),_:1})]),t("div",Je,[t("span",Me,d(((M=C.value.by_level)==null?void 0:M.ERROR)||0),1),e[20]||(e[20]=t("span",{class:"stat-label"},"错误",-1))])]),t("div",Ge,[t("div",Ke,[s(n,null,{default:a(()=>[s(me)]),_:1})]),t("div",He,[t("span",Qe,d(((G=C.value.by_level)==null?void 0:G.WARN)||0),1),e[21]||(e[21]=t("span",{class:"stat-label"},"警告",-1))])]),t("div",Xe,[t("div",Ye,[s(n,null,{default:a(()=>[s(fe)]),_:1})]),t("div",Ze,[t("span",et,d(((K=C.value.by_level)==null?void 0:K.INFO)||0),1),e[22]||(e[22]=t("span",{class:"stat-label"},"信息",-1))])]),t("div",tt,[t("div",st,[s(n,null,{default:a(()=>[s(ge)]),_:1})]),t("div",lt,[t("span",at,d(C.value.uptime||"-"),1),e[23]||(e[23]=t("span",{class:"stat-label"},"运行时间",-1))])])]),t("div",ot,[t("div",nt,[s(ke,{modelValue:r.value.keyword,"onUpdate:modelValue":e[0]||(e[0]=o=>r.value.keyword=o),placeholder:"搜索日志内容...",clearable:"",class:"search-input",onKeyup:Fe(U,["enter"])},{prefix:a(()=>[s(n,null,{default:a(()=>[s(P)]),_:1})]),_:1},8,["modelValue"]),s(J,{modelValue:r.value.level,"onUpdate:modelValue":e[1]||(e[1]=o=>r.value.level=o),placeholder:"日志级别",clearable:"",class:"filter-select"},{default:a(()=>[s(k,{label:"全部级别",value:""}),s(k,{label:"DEBUG",value:"DEBUG"}),s(k,{label:"INFO",value:"INFO"}),s(k,{label:"WARN",value:"WARN"}),s(k,{label:"ERROR",value:"ERROR"}),s(k,{label:"FATAL",value:"FATAL"})]),_:1},8,["modelValue"]),s(J,{modelValue:r.value.task_id,"onUpdate:modelValue":e[2]||(e[2]=o=>r.value.task_id=o),placeholder:"选择任务",clearable:"",filterable:"",class:"filter-select-task"},{default:a(()=>[s(k,{label:"全部任务",value:""}),(u(!0),_(E,null,O(N.value,o=>(u(),F(k,{key:o.id,label:`${o.name} (${o.id.substring(0,8)})`,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(f,{type:"primary",onClick:U},{default:a(()=>[s(n,null,{default:a(()=>[s(P)]),_:1}),e[24]||(e[24]=p("搜索 ",-1))]),_:1}),s(f,{onClick:Z},{default:a(()=>[...e[25]||(e[25]=[p("重置",-1)])]),_:1})])]),t("div",it,[t("div",dt,[t("span",ut,"共 "+d($.value)+" 条日志",1),t("div",rt,[s(ye,{modelValue:T.value,"onUpdate:modelValue":e[3]||(e[3]=o=>T.value=o),onChange:se},{default:a(()=>[...e[26]||(e[26]=[p(" 自动刷新 (5s) ",-1)])]),_:1},8,["modelValue"]),s(f,{text:"",onClick:ie,disabled:h.value.length===0},{default:a(()=>[s(n,null,{default:a(()=>[s(q)]),_:1}),e[27]||(e[27]=p("复制全部 ",-1))]),_:1},8,["disabled"])])]),$e((u(),_("div",ct,[h.value.length===0&&!L.value?(u(),_("div",_t,[s(n,{size:48},{default:a(()=>[s(v)]),_:1}),e[28]||(e[28]=t("p",null,"暂无日志记录",-1))])):m("",!0),(u(!0),_(E,null,O(h.value,o=>(u(),_("div",{key:o.id,class:I(["log-item",`level-${o.level.toLowerCase()}`]),onClick:A=>oe(o)},[t("div",pt,[t("span",{class:I(["log-level",o.level.toLowerCase()])},d(o.level),3),t("span",mt,d(o.timestamp),1),o.source?(u(),_("span",ft,d(o.source),1)):m("",!0),o.request_id?(u(),_("span",gt,[s(n,null,{default:a(()=>[s(be)]),_:1}),p(" "+d(o.request_id.substring(0,8)),1)])):m("",!0),o.task_id?(u(),_("span",kt,[s(n,null,{default:a(()=>[s(he)]),_:1}),p(" "+d(o.task_id.substring(0,8)),1)])):m("",!0)]),t("div",yt,d(o.message),1),o.fields&&Object.keys(o.fields).length>0?(u(),_("div",bt,[(u(!0),_(E,null,O(o.fields,(A,H)=>(u(),_("span",{key:H,class:"field-item"},[t("span",ht,d(H)+":",1),t("span",wt,d(ne(A)),1)]))),128))])):m("",!0),t("div",Ct,[s(f,{text:"",size:"small",onClick:Re(A=>B(o),["stop"])},{default:a(()=>[s(n,null,{default:a(()=>[s(q)]),_:1}),e[29]||(e[29]=p("复制 ",-1))]),_:1},8,["onClick"])])],10,vt))),128))])),[[xe,L.value]]),$.value>w.value?(u(),_("div",xt,[s(we,{"current-page":y.value,"onUpdate:currentPage":e[4]||(e[4]=o=>y.value=o),"page-size":w.value,"onUpdate:pageSize":e[5]||(e[5]=o=>w.value=o),"page-sizes":[50,100,200,500],total:$.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:te,onCurrentChange:ee},null,8,["current-page","page-size","total"])])):m("",!0)]),s(Ce,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=o=>R.value=o),title:"日志详情",width:"800px",class:"log-detail-dialog"},{footer:a(()=>[s(f,{onClick:e[6]||(e[6]=o=>B(c.value))},{default:a(()=>[s(n,null,{default:a(()=>[s(q)]),_:1}),e[40]||(e[40]=p("复制日志 ",-1))]),_:1}),s(f,{type:"primary",onClick:e[7]||(e[7]=o=>R.value=!1)},{default:a(()=>[...e[41]||(e[41]=[p("关闭",-1)])]),_:1})]),default:a(()=>[c.value?(u(),_("div",Lt,[t("div",Vt,[e[36]||(e[36]=t("h4",null,"基本信息",-1)),t("div",Dt,[t("div",Ft,[e[30]||(e[30]=t("span",{class:"label"},"ID",-1)),t("span",$t,d(c.value.id),1)]),t("div",Rt,[e[31]||(e[31]=t("span",{class:"label"},"级别",-1)),t("span",{class:I(["value","level-badge",c.value.level.toLowerCase()])},d(c.value.level),3)]),t("div",St,[e[32]||(e[32]=t("span",{class:"label"},"时间",-1)),t("span",zt,d(c.value.timestamp),1)]),t("div",Nt,[e[33]||(e[33]=t("span",{class:"label"},"来源",-1)),t("span",jt,d(c.value.source||"-"),1)]),c.value.request_id?(u(),_("div",qt,[e[34]||(e[34]=t("span",{class:"label"},"请求ID",-1)),t("span",At,d(c.value.request_id),1)])):m("",!0),c.value.task_id?(u(),_("div",Et,[e[35]||(e[35]=t("span",{class:"label"},"任务ID",-1)),t("span",Ot,d(c.value.task_id),1)])):m("",!0)])]),t("div",It,[e[37]||(e[37]=t("h4",null,"日志消息",-1)),t("div",Tt,d(c.value.message),1)]),c.value.fields&&Object.keys(c.value.fields).length>0?(u(),_("div",Ut,[e[38]||(e[38]=t("h4",null,"附加字段",-1)),t("pre",Bt,d(JSON.stringify(c.value.fields,null,2)),1)])):m("",!0),c.value.stack?(u(),_("div",Wt,[e[39]||(e[39]=t("h4",null,"堆栈跟踪",-1)),t("pre",Pt,d(c.value.stack),1)])):m("",!0)])):m("",!0)]),_:1},8,["modelValue"])])}}},Kt=Le(Jt,[["__scopeId","data-v-451ddd77"]]);export{Kt as default};
