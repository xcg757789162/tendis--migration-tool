import{_ as Is,o as Ns,a as Os,b as r,c,d as s,e as l,w as a,f as _,t as o,h as D,g as ds,F as N,m as p,n as js,r as z,i as w,k,j as d,E as f,s as O,p as M,v as Us}from"./index-aaIhUkFC.js";const zs={key:0,class:"task-detail"},Ms={class:"page-header"},Ys={class:"header-left"},$s={class:"title-section"},Hs={class:"task-id-row"},Ps={class:"header-actions"},Ws={key:0,class:"progress-overview card"},As={class:"overview-header"},Js={class:"header-right"},Gs={class:"phase-tag"},qs={class:"big-progress"},Qs={class:"progress-circle"},Xs={viewBox:"0 0 100 100"},Zs={class:"progress-text"},se={class:"percent"},ee={class:"progress-stats"},te={class:"stat-row"},le={class:"stat-item"},ae={class:"value stat-number"},oe={class:"stat-item"},ne={class:"value"},ie={class:"stat-item"},re={class:"value filtered"},de={class:"stat-row"},ue={class:"stat-item"},ce={class:"value"},_e={class:"stat-item"},ve={class:"value"},pe={class:"stat-row"},fe={class:"stat-item"},me={class:"value highlight"},ye={class:"stat-item"},ge={class:"value"},ke={class:"stat-item"},he={class:"value elapsed"},be={class:"info-grid"},we={class:"info-card card"},Ce={class:"cluster-info"},xe={class:"info-card card"},Te={class:"cluster-info"},Le={class:"info-card card"},Re={class:"config-info"},De={class:"config-row"},Ke={class:"value"},Fe={class:"config-row"},Ve={class:"value"},Se={class:"config-row"},Be={class:"value"},Ee={class:"config-row"},Ie={class:"value"},Ne={class:"info-card card"},Oe={class:"config-info"},je={class:"config-row"},Ue={class:"value"},ze={key:0,class:"config-row"},Me={class:"value"},Ye={key:1,class:"config-row"},$e={class:"value"},He={key:2,class:"config-row"},Pe={class:"value"},We={key:3,class:"config-row"},Ae={class:"value"},Je={key:1,class:"verify-section card"},Ge={class:"mono"},qe={key:2,class:"error-keys-section card"},Qe={class:"section-header"},Xe={class:"error-stats"},Ze={class:"stat-item"},st={class:"stat-value error"},et={class:"stat-item"},tt={class:"stat-value warning"},lt={class:"stat-item"},at={class:"stat-value info"},ot={class:"stat-item"},nt={class:"stat-value"},it={key:0,class:"error-keys-list"},rt={class:"mono"},dt={key:0,class:"list-footer"},ut={key:1,class:"no-errors"},ct={class:"task-logs card"},_t={class:"logs-header"},vt={class:"logs-actions"},pt={key:0,class:"no-logs"},ft={class:"log-time"},mt={class:"log-message"},yt={key:0,class:"log-fields"},gt={key:1,class:"loading"},kt={__name:"TaskDetail",setup(ht){const us=Us(),g=O(()=>us.params.id),n=k(null),v=k(null),F=k([]),V=k([]),S=k(""),cs=k(null),L=k(1e4),j=k(!1),m=k({total:0,failed:0,skipped:0,large_keys:0}),R=k([]);let x=null;const _s=O(()=>{var t;if(!((t=n.value)!=null&&t.source_cluster))return{};if(typeof n.value.source_cluster=="object")return n.value.source_cluster;try{return JSON.parse(n.value.source_cluster)}catch{return typeof n.value.source_cluster=="string"?{addrs:n.value.source_cluster.split(",").map(e=>e.trim()).filter(e=>e)}:{}}}),vs=O(()=>{var t;if(!((t=n.value)!=null&&t.target_cluster))return{};if(typeof n.value.target_cluster=="object")return n.value.target_cluster;try{return JSON.parse(n.value.target_cluster)}catch{return typeof n.value.target_cluster=="string"?{addrs:n.value.target_cluster.split(",").map(e=>e.trim()).filter(e=>e)}:{}}}),B=O(()=>{var t;try{return JSON.parse(((t=n.value)==null?void 0:t.config)||"{}")}catch{return{}}}),T=async()=>{try{j.value=!0;const t=await w.getTask(g.value);n.value=t,v.value=t.progress}catch(t){console.error("Fetch task failed:",t)}finally{j.value=!1}},ps=()=>{x&&(clearInterval(x),x=null),L.value>0&&(x=setInterval(()=>{var t;((t=n.value)==null?void 0:t.status)==="running"&&(T(),E())},L.value))},Y=async()=>{try{const t=await w.getVerifyResults(g.value);F.value=t||[]}catch{F.value=[]}},$=async()=>{try{const t=await w.getErrorKeys(g.value);m.value=(t==null?void 0:t.stats)||{total:0,failed:0,skipped:0,large_keys:0},R.value=(t==null?void 0:t.items)||[]}catch{m.value={total:0,failed:0,skipped:0,large_keys:0},R.value=[]}},H=async()=>{try{const t=await w.downloadErrorKeys(g.value),e=window.URL.createObjectURL(t),h=document.createElement("a");h.href=e,h.download=`error-keys-${g.value.substring(0,8)}-${M().format("YYYYMMDDHHmmss")}.csv`,document.body.appendChild(h),h.click(),window.URL.revokeObjectURL(e),document.body.removeChild(h),f.success("下载成功")}catch(t){f.error("下载失败: "+(t.message||"未知错误"))}},fs=t=>({failed:"danger",skipped:"warning",large_key:"info",timeout:"danger",conflict:"warning"})[t]||"info",ms=t=>({failed:"迁移失败",skipped:"冲突跳过",large_key:"大Key",timeout:"超时",conflict:"键冲突"})[t]||t,E=async()=>{try{const t={limit:100};S.value&&(t.level=S.value);const e=await w.getTaskLogs(g.value,t);V.value=(e==null?void 0:e.items)||[]}catch(t){console.error("Fetch task logs failed:",t),V.value=[]}},P=t=>M(t).format("HH:mm:ss.SSS"),ys=t=>{if(!t||typeof t!="object")return"";const e=Object.entries(t);return e.length===0?"":e.map(([h,u])=>`${h}=${JSON.stringify(u)}`).join(" ")},gs=async()=>{try{await w.startTask(g.value),f.success("任务已启动"),T()}catch{f.error("启动失败")}},ks=async()=>{try{await w.pauseTask(g.value),f.success("任务已暂停"),T()}catch{f.error("暂停失败")}},hs=async()=>{try{await w.resumeTask(g.value),f.success("任务已恢复"),T()}catch{f.error("恢复失败")}},bs=async()=>{try{await w.triggerVerify(g.value),f.success("校验任务已触发"),setTimeout(Y,3e3)}catch{f.error("触发校验失败")}},W=async()=>{try{await navigator.clipboard.writeText(n.value.id),f.success("任务ID已复制")}catch{f.error("复制失败")}},ws=t=>({pending:"待启动",running:"运行中",paused:"已暂停",completed:"已完成",failed:"失败"})[t]||t,Cs=t=>({full:"全量迁移",incremental:"增量同步",verify:"数据校验"})[t]||t,I=t=>t>=1e9?(t/1e9).toFixed(1)+"B":t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":t.toString(),U=t=>t>=1099511627776?(t/1099511627776).toFixed(2)+" TB":t>=1073741824?(t/1073741824).toFixed(2)+" GB":t>=1048576?(t/1048576).toFixed(2)+" MB":t>=1024?(t/1024).toFixed(2)+" KB":t+" B",A=t=>M(t).format("YYYY-MM-DD HH:mm:ss");return Ns(()=>{T(),Y(),E(),$(),L.value>0&&(x=setInterval(()=>{var t;((t=n.value)==null?void 0:t.status)==="running"&&(T(),E(),$())},L.value))}),Os(()=>{x&&clearInterval(x)}),(t,e)=>{var es,ts,ls,as,os,ns,is;const h=d("ArrowLeft"),u=d("el-icon"),b=d("el-button"),xs=d("el-tooltip"),Ts=d("CopyDocument"),J=d("VideoPlay"),Ls=d("VideoPause"),G=d("Checked"),C=d("el-option"),q=d("el-select"),Q=d("Refresh"),X=d("Connection"),Z=d("Link"),Rs=d("Setting"),Ds=d("Clock"),y=d("el-table-column"),ss=d("el-table"),Ks=d("Warning"),Fs=d("Download"),Vs=d("el-tag"),Ss=d("SuccessFilled"),Bs=d("Document"),Es=d("Loading");return n.value?(r(),c("div",zs,[s("div",Ms,[s("div",Ys,[l(b,{text:"",onClick:e[0]||(e[0]=i=>t.$router.push("/tasks"))},{default:a(()=>[l(u,null,{default:a(()=>[l(h)]),_:1}),e[3]||(e[3]=_(" 返回列表 ",-1))]),_:1}),s("div",$s,[s("h1",null,o(n.value.name),1),s("div",Hs,[e[4]||(e[4]=s("span",{class:"task-id-label"},"ID:",-1)),l(xs,{content:"点击复制",placement:"top"},{default:a(()=>[s("span",{class:"task-id",onClick:W},o(n.value.id),1)]),_:1}),l(u,{class:"copy-icon",onClick:W},{default:a(()=>[l(Ts)]),_:1})])]),s("span",{class:D(["status-tag",n.value.status])},o(ws(n.value.status)),3)]),s("div",Ps,[n.value.status==="pending"?(r(),ds(b,{key:0,type:"primary",onClick:gs},{default:a(()=>[l(u,null,{default:a(()=>[l(J)]),_:1}),e[5]||(e[5]=_(" 启动任务 ",-1))]),_:1})):n.value.status==="running"?(r(),c(N,{key:1},[l(b,{onClick:ks},{default:a(()=>[l(u,null,{default:a(()=>[l(Ls)]),_:1}),e[6]||(e[6]=_(" 暂停 ",-1))]),_:1}),l(b,{type:"primary",onClick:bs},{default:a(()=>[l(u,null,{default:a(()=>[l(G)]),_:1}),e[7]||(e[7]=_(" 校验 ",-1))]),_:1})],64)):n.value.status==="paused"?(r(),ds(b,{key:2,type:"primary",onClick:hs},{default:a(()=>[l(u,null,{default:a(()=>[l(J)]),_:1}),e[8]||(e[8]=_(" 恢复 ",-1))]),_:1})):p("",!0)])]),v.value?(r(),c("div",Ws,[s("div",As,[e[10]||(e[10]=s("h2",null,"迁移进度",-1)),s("div",Js,[l(q,{modelValue:L.value,"onUpdate:modelValue":e[1]||(e[1]=i=>L.value=i),size:"small",style:{width:"120px"},onChange:ps},{default:a(()=>[l(C,{label:"手动刷新",value:0}),l(C,{label:"每 10 秒",value:1e4}),l(C,{label:"每 30 秒",value:3e4}),l(C,{label:"每 1 分钟",value:6e4})]),_:1},8,["modelValue"]),l(b,{size:"small",onClick:T,loading:j.value},{default:a(()=>[l(u,null,{default:a(()=>[l(Q)]),_:1}),e[9]||(e[9]=_(" 刷新 ",-1))]),_:1},8,["loading"]),s("span",Gs,o(Cs(v.value.phase)),1)])]),s("div",qs,[s("div",Qs,[(r(),c("svg",Xs,[e[11]||(e[11]=s("circle",{class:"bg",cx:"50",cy:"50",r:"45"},null,-1)),s("circle",{class:"progress",cx:"50",cy:"50",r:"45",style:js({strokeDasharray:`${v.value.percentage*2.83} 283`})},null,4)])),s("div",Zs,[s("span",se,o(((es=v.value.percentage)==null?void 0:es.toFixed(1))||0),1),e[12]||(e[12]=s("span",{class:"unit"},"%",-1))])]),s("div",ee,[s("div",te,[s("div",le,[e[13]||(e[13]=s("span",{class:"label"},"已迁移Key",-1)),s("span",ae,o(I(v.value.migrated_keys||0)),1)]),s("div",oe,[e[14]||(e[14]=s("span",{class:"label"},"总Key数",-1)),s("span",ne,o(I(v.value.total_keys||0)),1)]),s("div",ie,[e[15]||(e[15]=s("span",{class:"label"},"过滤Key",-1)),s("span",re,o(I(n.value.keys_filtered||0)),1)])]),s("div",de,[s("div",ue,[e[16]||(e[16]=s("span",{class:"label"},"已迁移数据",-1)),s("span",ce,o(U(v.value.migrated_bytes||0)),1)]),s("div",_e,[e[17]||(e[17]=s("span",{class:"label"},"总数据量",-1)),s("span",ve,o(U(v.value.total_bytes||0)),1)])]),s("div",pe,[s("div",fe,[e[18]||(e[18]=s("span",{class:"label"},"当前速度",-1)),s("span",me,o(I(v.value.current_speed||0))+" keys/s",1)]),s("div",ye,[e[19]||(e[19]=s("span",{class:"label"},"预计剩余时间",-1)),s("span",ge,o(v.value.estimated_eta||"-"),1)]),s("div",ke,[e[20]||(e[20]=s("span",{class:"label"},"已耗时间",-1)),s("span",he,o(v.value.elapsed_time||"-"),1)])])])])])):p("",!0),s("div",be,[s("div",we,[s("h3",null,[l(u,null,{default:a(()=>[l(X)]),_:1}),e[21]||(e[21]=_(" 源集群",-1))]),s("div",Ce,[(r(!0),c(N,null,z(((ts=_s.value)==null?void 0:ts.addrs)||[],i=>(r(),c("div",{class:"info-row",key:i},[l(u,null,{default:a(()=>[l(Z)]),_:1}),s("span",null,o(i),1)]))),128))])]),s("div",xe,[s("h3",null,[l(u,null,{default:a(()=>[l(X)]),_:1}),e[22]||(e[22]=_(" 目标集群",-1))]),s("div",Te,[(r(!0),c(N,null,z(((ls=vs.value)==null?void 0:ls.addrs)||[],i=>(r(),c("div",{class:"info-row",key:i},[l(u,null,{default:a(()=>[l(Z)]),_:1}),s("span",null,o(i),1)]))),128))])]),s("div",Le,[s("h3",null,[l(u,null,{default:a(()=>[l(Rs)]),_:1}),e[23]||(e[23]=_(" 任务配置",-1))]),s("div",Re,[s("div",De,[e[24]||(e[24]=s("span",{class:"label"},"Worker数量",-1)),s("span",Ke,o(((as=B.value)==null?void 0:as.worker_count)||4),1)]),s("div",Fe,[e[25]||(e[25]=s("span",{class:"label"},"冲突策略",-1)),s("span",Ve,o(((os=B.value)==null?void 0:os.conflict_policy)||"skip_full_only"),1)]),s("div",Se,[e[26]||(e[26]=s("span",{class:"label"},"大Key阈值",-1)),s("span",Be,o(U(((ns=B.value)==null?void 0:ns.large_key_threshold)||10485760)),1)]),s("div",Ee,[e[27]||(e[27]=s("span",{class:"label"},"启用压缩",-1)),s("span",Ie,o((is=B.value)!=null&&is.enable_compression?"是":"否"),1)])])]),s("div",Ne,[s("h3",null,[l(u,null,{default:a(()=>[l(Ds)]),_:1}),e[28]||(e[28]=_(" 时间信息",-1))]),s("div",Oe,[s("div",je,[e[29]||(e[29]=s("span",{class:"label"},"创建时间",-1)),s("span",Ue,o(A(n.value.created_at)),1)]),n.value.started_at?(r(),c("div",ze,[e[30]||(e[30]=s("span",{class:"label"},"启动时间",-1)),s("span",Me,o(n.value.started_at),1)])):p("",!0),n.value.full_start_at?(r(),c("div",Ye,[e[31]||(e[31]=s("span",{class:"label"},"全量开始",-1)),s("span",$e,o(n.value.full_start_at),1)])):p("",!0),n.value.incr_start_at?(r(),c("div",He,[e[32]||(e[32]=s("span",{class:"label"},"增量开始",-1)),s("span",Pe,o(n.value.incr_start_at),1)])):p("",!0),n.value.completed_at?(r(),c("div",We,[e[33]||(e[33]=s("span",{class:"label"},"完成时间",-1)),s("span",Ae,o(A(n.value.completed_at)),1)])):p("",!0)])])]),F.value.length?(r(),c("div",Je,[s("h3",null,[l(u,null,{default:a(()=>[l(G)]),_:1}),e[34]||(e[34]=_(" 校验结果",-1))]),l(ss,{data:F.value,style:{width:"100%"}},{default:a(()=>[l(y,{label:"批次ID",width:"200"},{default:a(({row:i})=>[s("span",Ge,o(i.batch_id.slice(0,8))+"...",1)]),_:1}),l(y,{label:"采样Key数",prop:"total_keys",width:"120"}),l(y,{label:"匹配数",prop:"matched_keys",width:"100"}),l(y,{label:"不一致",width:"100"},{default:a(({row:i})=>[s("span",{class:D({"error-text":i.mismatched_keys>0})},o(i.mismatched_keys),3)]),_:1}),l(y,{label:"缺失Key",width:"100"},{default:a(({row:i})=>[s("span",{class:D({"error-text":i.missing_keys>0})},o(i.missing_keys),3)]),_:1}),l(y,{label:"一致性"},{default:a(({row:i})=>{var K;return[s("span",{class:D(["consistency-rate",{high:i.consistency_rate>=99.9}])},o(((K=i.consistency_rate)==null?void 0:K.toFixed(2))||0)+"% ",3)]}),_:1})]),_:1},8,["data"])])):p("",!0),n.value.status==="completed"||n.value.status==="failed"||m.value.total>0?(r(),c("div",qe,[s("div",Qe,[s("h3",null,[l(u,null,{default:a(()=>[l(Ks)]),_:1}),e[35]||(e[35]=_(" 异常/跳过Key统计",-1))]),l(b,{type:"primary",size:"small",onClick:H,disabled:m.value.total===0},{default:a(()=>[l(u,null,{default:a(()=>[l(Fs)]),_:1}),e[36]||(e[36]=_(" 下载详情 ",-1))]),_:1},8,["disabled"])]),s("div",Xe,[s("div",Ze,[s("span",st,o(m.value.failed||0),1),e[37]||(e[37]=s("span",{class:"stat-label"},"迁移失败",-1))]),s("div",et,[s("span",tt,o(m.value.skipped||0),1),e[38]||(e[38]=s("span",{class:"stat-label"},"冲突跳过",-1))]),s("div",lt,[s("span",at,o(m.value.large_keys||0),1),e[39]||(e[39]=s("span",{class:"stat-label"},"大Key处理",-1))]),s("div",ot,[s("span",nt,o(m.value.total||0),1),e[40]||(e[40]=s("span",{class:"stat-label"},"异常总数",-1))])]),R.value.length>0?(r(),c("div",it,[l(ss,{data:R.value,style:{width:"100%"},"max-height":"300"},{default:a(()=>[l(y,{label:"Key名称","min-width":"200"},{default:a(({row:i})=>[s("span",rt,o(i.key),1)]),_:1}),l(y,{label:"类型",width:"100",prop:"type"}),l(y,{label:"原因",width:"120"},{default:a(({row:i})=>[l(Vs,{type:fs(i.reason),size:"small"},{default:a(()=>[_(o(ms(i.reason)),1)]),_:2},1032,["type"])]),_:1}),l(y,{label:"详情","min-width":"200",prop:"detail"}),l(y,{label:"时间",width:"100"},{default:a(({row:i})=>[_(o(P(i.timestamp)),1)]),_:1})]),_:1},8,["data"]),m.value.total>R.value.length?(r(),c("div",dt,[s("span",null,"显示前 "+o(R.value.length)+" 条，共 "+o(m.value.total)+" 条",1),l(b,{text:"",type:"primary",onClick:H},{default:a(()=>[...e[41]||(e[41]=[_("查看全部并下载",-1)])]),_:1})])):p("",!0)])):m.value.total===0?(r(),c("div",ut,[l(u,null,{default:a(()=>[l(Ss)]),_:1}),e[42]||(e[42]=s("span",null,"暂无异常Key",-1))])):p("",!0)])):p("",!0),s("div",ct,[s("div",_t,[s("h3",null,[l(u,null,{default:a(()=>[l(Bs)]),_:1}),e[43]||(e[43]=_(" 任务日志",-1))]),s("div",vt,[l(q,{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=i=>S.value=i),placeholder:"日志级别",size:"small",style:{width:"100px"},clearable:""},{default:a(()=>[l(C,{label:"DEBUG",value:"DEBUG"}),l(C,{label:"INFO",value:"INFO"}),l(C,{label:"WARN",value:"WARN"}),l(C,{label:"ERROR",value:"ERROR"})]),_:1},8,["modelValue"]),l(b,{size:"small",onClick:E},{default:a(()=>[l(u,null,{default:a(()=>[l(Q)]),_:1}),e[44]||(e[44]=_(" 刷新 ",-1))]),_:1})])]),s("div",{class:"logs-container",ref_key:"logsContainer",ref:cs},[V.value.length===0?(r(),c("div",pt," 暂无日志 ")):p("",!0),(r(!0),c(N,null,z(V.value,i=>{var K,rs;return r(),c("div",{key:i.id,class:D(["log-entry",(K=i.level)==null?void 0:K.toLowerCase()])},[s("span",ft,o(P(i.timestamp)),1),s("span",{class:D(["log-level",(rs=i.level)==null?void 0:rs.toLowerCase()])},o(i.level),3),s("span",mt,o(i.message),1),i.fields?(r(),c("span",yt,o(ys(i.fields)),1)):p("",!0)],2)}),128))],512)])])):(r(),c("div",gt,[l(u,{class:"loading-icon"},{default:a(()=>[l(Es)]),_:1}),e[45]||(e[45]=s("span",null,"加载中...",-1))]))}}},wt=Is(kt,[["__scopeId","data-v-db57ccf8"]]);export{wt as default};
