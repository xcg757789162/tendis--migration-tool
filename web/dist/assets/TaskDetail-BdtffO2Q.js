import{_ as Ns,o as Os,a as js,b as i,c,d as e,e as l,w as a,f as _,t as o,h as D,g as ds,F as N,m as p,n as Us,r as z,i as w,k as h,j as d,E as f,s as O,p as M,v as zs}from"./index-CndybKqV.js";const Ms={key:0,class:"task-detail"},Ys={class:"page-header"},Ps={class:"header-left"},$s={class:"title-section"},Hs={class:"task-id-row"},Ws={class:"header-actions"},As={key:0,class:"progress-overview card"},Js={class:"overview-header"},Gs={class:"header-right"},qs={class:"phase-tag"},Qs={class:"big-progress"},Xs={class:"progress-circle"},Zs={viewBox:"0 0 100 100"},se={class:"progress-text"},ee={class:"percent"},te={class:"progress-stats"},le={class:"stat-row"},ae={class:"stat-item"},oe={class:"value stat-number"},ne={class:"stat-item"},re={class:"value"},ie={class:"stat-item"},de={class:"value filtered"},ue={class:"stat-row"},ce={class:"stat-item"},_e={class:"value"},ve={class:"stat-item"},pe={class:"value"},fe={class:"stat-row"},me={class:"stat-item"},ye={class:"value highlight"},ge={class:"stat-item"},ke={class:"value"},he={class:"stat-item"},be={class:"value elapsed"},we={class:"info-grid"},Ce={class:"info-card card"},xe={class:"cluster-info"},Te={class:"info-card card"},Le={class:"cluster-info"},Re={class:"info-card card"},De={class:"config-info"},Ke={class:"config-row"},Fe={class:"value"},Ve={class:"config-row"},Se={class:"value"},Ee={class:"config-row"},Be={class:"value"},Ie={class:"config-row"},Ne={class:"value"},Oe={class:"info-card card"},je={class:"config-info"},Ue={class:"config-row"},ze={class:"value"},Me={key:0,class:"config-row"},Ye={class:"value"},Pe={key:1,class:"config-row"},$e={class:"value"},He={key:2,class:"config-row"},We={class:"value"},Ae={key:3,class:"config-row"},Je={class:"value"},Ge={key:1,class:"verify-section card"},qe={class:"mono"},Qe={key:2,class:"error-keys-section card"},Xe={class:"section-header"},Ze={class:"error-stats"},st={class:"stat-item"},et={class:"stat-value error"},tt={class:"stat-item"},lt={class:"stat-value warning"},at={class:"stat-item"},ot={class:"stat-value info"},nt={class:"stat-item"},rt={class:"stat-value"},it={key:0,class:"error-keys-list"},dt={class:"mono"},ut={key:0,class:"list-footer"},ct={key:1,class:"no-errors"},_t={class:"task-logs card"},vt={class:"logs-header"},pt={class:"logs-actions"},ft={key:0,class:"no-logs"},mt={class:"log-time"},yt={class:"log-message"},gt={key:0,class:"log-fields"},kt={key:1,class:"loading"},ht={__name:"TaskDetail",setup(bt){const us=zs(),k=O(()=>us.params.id),n=h(null),v=h(null),F=h([]),V=h([]),S=h(""),cs=h(null),L=h(1e4),j=h(!1),m=h({total:0,failed:0,skipped:0,large_keys:0}),R=h([]);let x=null;const _s=O(()=>{var t;if(!((t=n.value)!=null&&t.source_cluster))return{};if(typeof n.value.source_cluster=="object")return n.value.source_cluster;try{return JSON.parse(n.value.source_cluster)}catch{return typeof n.value.source_cluster=="string"?{addrs:n.value.source_cluster.split(",").map(s=>s.trim()).filter(s=>s)}:{}}}),vs=O(()=>{var t;if(!((t=n.value)!=null&&t.target_cluster))return{};if(typeof n.value.target_cluster=="object")return n.value.target_cluster;try{return JSON.parse(n.value.target_cluster)}catch{return typeof n.value.target_cluster=="string"?{addrs:n.value.target_cluster.split(",").map(s=>s.trim()).filter(s=>s)}:{}}}),E=O(()=>{var t;try{return JSON.parse(((t=n.value)==null?void 0:t.config)||"{}")}catch{return{}}}),T=async()=>{try{j.value=!0;const t=await w.getTask(k.value);n.value=t,v.value=t.progress}catch(t){console.error("Fetch task failed:",t)}finally{j.value=!1}},ps=()=>{x&&(clearInterval(x),x=null),L.value>0&&(x=setInterval(()=>{var t;((t=n.value)==null?void 0:t.status)==="running"&&(T(),B())},L.value))},Y=async()=>{try{const t=await w.getVerifyResults(k.value);F.value=t||[]}catch{F.value=[]}},P=async()=>{try{const t=await w.getErrorKeys(k.value);m.value=(t==null?void 0:t.stats)||{total:0,failed:0,skipped:0,large_keys:0},R.value=(t==null?void 0:t.items)||[]}catch{m.value={total:0,failed:0,skipped:0,large_keys:0},R.value=[]}},$=async()=>{try{const t=await w.downloadErrorKeys(k.value),s=window.URL.createObjectURL(t),y=document.createElement("a");y.href=s,y.download=`error-keys-${k.value.substring(0,8)}-${M().format("YYYYMMDDHHmmss")}.csv`,document.body.appendChild(y),y.click(),window.URL.revokeObjectURL(s),document.body.removeChild(y),f.success("下载成功")}catch(t){f.error("下载失败: "+(t.message||"未知错误"))}},fs=t=>({failed:"danger",skipped:"warning",large_key:"info",timeout:"danger",conflict:"warning"})[t]||"info",ms=t=>({failed:"迁移失败",skipped:"冲突跳过",large_key:"大Key",timeout:"超时",conflict:"键冲突"})[t]||t,B=async()=>{try{const t={limit:100};S.value&&(t.level=S.value);const s=await w.getTaskLogs(k.value,t);V.value=(s==null?void 0:s.items)||[]}catch(t){console.error("Fetch task logs failed:",t),V.value=[]}},H=t=>M(t).format("HH:mm:ss.SSS"),ys=t=>{if(!t||typeof t!="object")return"";const s=Object.entries(t);return s.length===0?"":s.map(([y,u])=>`${y}=${JSON.stringify(u)}`).join(" ")},gs=async()=>{try{await w.startTask(k.value),f.success("任务已启动"),T()}catch{f.error("启动失败")}},ks=async()=>{try{await w.pauseTask(k.value),f.success("任务已暂停"),T()}catch{f.error("暂停失败")}},hs=async()=>{try{await w.resumeTask(k.value),f.success("任务已恢复"),T()}catch{f.error("恢复失败")}},bs=async()=>{try{await w.triggerVerify(k.value),f.success("校验任务已触发"),setTimeout(Y,3e3)}catch{f.error("触发校验失败")}},ws=t=>{if(navigator.clipboard&&window.isSecureContext)return navigator.clipboard.writeText(t);const s=document.createElement("textarea");s.value=t,s.style.position="fixed",s.style.left="-9999px",document.body.appendChild(s),s.select();try{return document.execCommand("copy"),Promise.resolve()}catch(y){return Promise.reject(y)}finally{document.body.removeChild(s)}},W=async()=>{try{await ws(n.value.id),f.success("任务ID已复制")}catch{f.error("复制失败")}},Cs=t=>({pending:"待启动",running:"运行中",paused:"已暂停",completed:"已完成",failed:"失败"})[t]||t,xs=t=>({full:"全量迁移",incremental:"增量同步",verify:"数据校验"})[t]||t,I=t=>t>=1e9?(t/1e9).toFixed(1)+"B":t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":t.toString(),U=t=>t>=1099511627776?(t/1099511627776).toFixed(2)+" TB":t>=1073741824?(t/1073741824).toFixed(2)+" GB":t>=1048576?(t/1048576).toFixed(2)+" MB":t>=1024?(t/1024).toFixed(2)+" KB":t+" B",A=t=>M(t).format("YYYY-MM-DD HH:mm:ss");return Os(()=>{T(),Y(),B(),P(),L.value>0&&(x=setInterval(()=>{var t;((t=n.value)==null?void 0:t.status)==="running"&&(T(),B(),P())},L.value))}),js(()=>{x&&clearInterval(x)}),(t,s)=>{var es,ts,ls,as,os,ns,rs;const y=d("ArrowLeft"),u=d("el-icon"),b=d("el-button"),Ts=d("el-tooltip"),Ls=d("CopyDocument"),J=d("VideoPlay"),Rs=d("VideoPause"),G=d("Checked"),C=d("el-option"),q=d("el-select"),Q=d("Refresh"),X=d("Connection"),Z=d("Link"),Ds=d("Setting"),Ks=d("Clock"),g=d("el-table-column"),ss=d("el-table"),Fs=d("Warning"),Vs=d("Download"),Ss=d("el-tag"),Es=d("SuccessFilled"),Bs=d("Document"),Is=d("Loading");return n.value?(i(),c("div",Ms,[e("div",Ys,[e("div",Ps,[l(b,{text:"",onClick:s[0]||(s[0]=r=>t.$router.push("/tasks"))},{default:a(()=>[l(u,null,{default:a(()=>[l(y)]),_:1}),s[3]||(s[3]=_(" 返回列表 ",-1))]),_:1}),e("div",$s,[e("h1",null,o(n.value.name),1),e("div",Hs,[s[4]||(s[4]=e("span",{class:"task-id-label"},"ID:",-1)),l(Ts,{content:"点击复制",placement:"top"},{default:a(()=>[e("span",{class:"task-id",onClick:W},o(n.value.id),1)]),_:1}),l(u,{class:"copy-icon",onClick:W},{default:a(()=>[l(Ls)]),_:1})])]),e("span",{class:D(["status-tag",n.value.status])},o(Cs(n.value.status)),3)]),e("div",Ws,[n.value.status==="pending"?(i(),ds(b,{key:0,type:"primary",onClick:gs},{default:a(()=>[l(u,null,{default:a(()=>[l(J)]),_:1}),s[5]||(s[5]=_(" 启动任务 ",-1))]),_:1})):n.value.status==="running"?(i(),c(N,{key:1},[l(b,{onClick:ks},{default:a(()=>[l(u,null,{default:a(()=>[l(Rs)]),_:1}),s[6]||(s[6]=_(" 暂停 ",-1))]),_:1}),l(b,{type:"primary",onClick:bs},{default:a(()=>[l(u,null,{default:a(()=>[l(G)]),_:1}),s[7]||(s[7]=_(" 校验 ",-1))]),_:1})],64)):n.value.status==="paused"?(i(),ds(b,{key:2,type:"primary",onClick:hs},{default:a(()=>[l(u,null,{default:a(()=>[l(J)]),_:1}),s[8]||(s[8]=_(" 恢复 ",-1))]),_:1})):p("",!0)])]),v.value?(i(),c("div",As,[e("div",Js,[s[10]||(s[10]=e("h2",null,"迁移进度",-1)),e("div",Gs,[l(q,{modelValue:L.value,"onUpdate:modelValue":s[1]||(s[1]=r=>L.value=r),size:"small",style:{width:"120px"},onChange:ps},{default:a(()=>[l(C,{label:"手动刷新",value:0}),l(C,{label:"每 10 秒",value:1e4}),l(C,{label:"每 30 秒",value:3e4}),l(C,{label:"每 1 分钟",value:6e4})]),_:1},8,["modelValue"]),l(b,{size:"small",onClick:T,loading:j.value},{default:a(()=>[l(u,null,{default:a(()=>[l(Q)]),_:1}),s[9]||(s[9]=_(" 刷新 ",-1))]),_:1},8,["loading"]),e("span",qs,o(xs(v.value.phase)),1)])]),e("div",Qs,[e("div",Xs,[(i(),c("svg",Zs,[s[11]||(s[11]=e("circle",{class:"bg",cx:"50",cy:"50",r:"45"},null,-1)),e("circle",{class:"progress",cx:"50",cy:"50",r:"45",style:Us({strokeDasharray:`${v.value.percentage*2.83} 283`})},null,4)])),e("div",se,[e("span",ee,o(((es=v.value.percentage)==null?void 0:es.toFixed(1))||0),1),s[12]||(s[12]=e("span",{class:"unit"},"%",-1))])]),e("div",te,[e("div",le,[e("div",ae,[s[13]||(s[13]=e("span",{class:"label"},"已迁移Key",-1)),e("span",oe,o(I(v.value.migrated_keys||0)),1)]),e("div",ne,[s[14]||(s[14]=e("span",{class:"label"},"总Key数",-1)),e("span",re,o(I(v.value.total_keys||0)),1)]),e("div",ie,[s[15]||(s[15]=e("span",{class:"label"},"过滤Key",-1)),e("span",de,o(I(n.value.keys_filtered||0)),1)])]),e("div",ue,[e("div",ce,[s[16]||(s[16]=e("span",{class:"label"},"已迁移数据",-1)),e("span",_e,o(U(v.value.migrated_bytes||0)),1)]),e("div",ve,[s[17]||(s[17]=e("span",{class:"label"},"总数据量",-1)),e("span",pe,o(U(v.value.total_bytes||0)),1)])]),e("div",fe,[e("div",me,[s[18]||(s[18]=e("span",{class:"label"},"当前速度",-1)),e("span",ye,o(I(v.value.current_speed||0))+" keys/s",1)]),e("div",ge,[s[19]||(s[19]=e("span",{class:"label"},"预计剩余时间",-1)),e("span",ke,o(v.value.estimated_eta||"-"),1)]),e("div",he,[s[20]||(s[20]=e("span",{class:"label"},"已耗时间",-1)),e("span",be,o(v.value.elapsed_time||"-"),1)])])])])])):p("",!0),e("div",we,[e("div",Ce,[e("h3",null,[l(u,null,{default:a(()=>[l(X)]),_:1}),s[21]||(s[21]=_(" 源集群",-1))]),e("div",xe,[(i(!0),c(N,null,z(((ts=_s.value)==null?void 0:ts.addrs)||[],r=>(i(),c("div",{class:"info-row",key:r},[l(u,null,{default:a(()=>[l(Z)]),_:1}),e("span",null,o(r),1)]))),128))])]),e("div",Te,[e("h3",null,[l(u,null,{default:a(()=>[l(X)]),_:1}),s[22]||(s[22]=_(" 目标集群",-1))]),e("div",Le,[(i(!0),c(N,null,z(((ls=vs.value)==null?void 0:ls.addrs)||[],r=>(i(),c("div",{class:"info-row",key:r},[l(u,null,{default:a(()=>[l(Z)]),_:1}),e("span",null,o(r),1)]))),128))])]),e("div",Re,[e("h3",null,[l(u,null,{default:a(()=>[l(Ds)]),_:1}),s[23]||(s[23]=_(" 任务配置",-1))]),e("div",De,[e("div",Ke,[s[24]||(s[24]=e("span",{class:"label"},"Worker数量",-1)),e("span",Fe,o(((as=E.value)==null?void 0:as.worker_count)||4),1)]),e("div",Ve,[s[25]||(s[25]=e("span",{class:"label"},"冲突策略",-1)),e("span",Se,o(((os=E.value)==null?void 0:os.conflict_policy)||"skip_full_only"),1)]),e("div",Ee,[s[26]||(s[26]=e("span",{class:"label"},"大Key阈值",-1)),e("span",Be,o(U(((ns=E.value)==null?void 0:ns.large_key_threshold)||10485760)),1)]),e("div",Ie,[s[27]||(s[27]=e("span",{class:"label"},"启用压缩",-1)),e("span",Ne,o((rs=E.value)!=null&&rs.enable_compression?"是":"否"),1)])])]),e("div",Oe,[e("h3",null,[l(u,null,{default:a(()=>[l(Ks)]),_:1}),s[28]||(s[28]=_(" 时间信息",-1))]),e("div",je,[e("div",Ue,[s[29]||(s[29]=e("span",{class:"label"},"创建时间",-1)),e("span",ze,o(A(n.value.created_at)),1)]),n.value.started_at?(i(),c("div",Me,[s[30]||(s[30]=e("span",{class:"label"},"启动时间",-1)),e("span",Ye,o(n.value.started_at),1)])):p("",!0),n.value.full_start_at?(i(),c("div",Pe,[s[31]||(s[31]=e("span",{class:"label"},"全量开始",-1)),e("span",$e,o(n.value.full_start_at),1)])):p("",!0),n.value.incr_start_at?(i(),c("div",He,[s[32]||(s[32]=e("span",{class:"label"},"增量开始",-1)),e("span",We,o(n.value.incr_start_at),1)])):p("",!0),n.value.completed_at?(i(),c("div",Ae,[s[33]||(s[33]=e("span",{class:"label"},"完成时间",-1)),e("span",Je,o(A(n.value.completed_at)),1)])):p("",!0)])])]),F.value.length?(i(),c("div",Ge,[e("h3",null,[l(u,null,{default:a(()=>[l(G)]),_:1}),s[34]||(s[34]=_(" 校验结果",-1))]),l(ss,{data:F.value,style:{width:"100%"}},{default:a(()=>[l(g,{label:"批次ID",width:"200"},{default:a(({row:r})=>[e("span",qe,o(r.batch_id.slice(0,8))+"...",1)]),_:1}),l(g,{label:"采样Key数",prop:"total_keys",width:"120"}),l(g,{label:"匹配数",prop:"matched_keys",width:"100"}),l(g,{label:"不一致",width:"100"},{default:a(({row:r})=>[e("span",{class:D({"error-text":r.mismatched_keys>0})},o(r.mismatched_keys),3)]),_:1}),l(g,{label:"缺失Key",width:"100"},{default:a(({row:r})=>[e("span",{class:D({"error-text":r.missing_keys>0})},o(r.missing_keys),3)]),_:1}),l(g,{label:"一致性"},{default:a(({row:r})=>{var K;return[e("span",{class:D(["consistency-rate",{high:r.consistency_rate>=99.9}])},o(((K=r.consistency_rate)==null?void 0:K.toFixed(2))||0)+"% ",3)]}),_:1})]),_:1},8,["data"])])):p("",!0),n.value.status==="completed"||n.value.status==="failed"||m.value.total>0?(i(),c("div",Qe,[e("div",Xe,[e("h3",null,[l(u,null,{default:a(()=>[l(Fs)]),_:1}),s[35]||(s[35]=_(" 异常/跳过Key统计",-1))]),l(b,{type:"primary",size:"small",onClick:$,disabled:m.value.total===0},{default:a(()=>[l(u,null,{default:a(()=>[l(Vs)]),_:1}),s[36]||(s[36]=_(" 下载详情 ",-1))]),_:1},8,["disabled"])]),e("div",Ze,[e("div",st,[e("span",et,o(m.value.failed||0),1),s[37]||(s[37]=e("span",{class:"stat-label"},"迁移失败",-1))]),e("div",tt,[e("span",lt,o(m.value.skipped||0),1),s[38]||(s[38]=e("span",{class:"stat-label"},"冲突跳过",-1))]),e("div",at,[e("span",ot,o(m.value.large_keys||0),1),s[39]||(s[39]=e("span",{class:"stat-label"},"大Key处理",-1))]),e("div",nt,[e("span",rt,o(m.value.total||0),1),s[40]||(s[40]=e("span",{class:"stat-label"},"异常总数",-1))])]),R.value.length>0?(i(),c("div",it,[l(ss,{data:R.value,style:{width:"100%"},"max-height":"300"},{default:a(()=>[l(g,{label:"Key名称","min-width":"200"},{default:a(({row:r})=>[e("span",dt,o(r.key),1)]),_:1}),l(g,{label:"类型",width:"100",prop:"type"}),l(g,{label:"原因",width:"120"},{default:a(({row:r})=>[l(Ss,{type:fs(r.reason),size:"small"},{default:a(()=>[_(o(ms(r.reason)),1)]),_:2},1032,["type"])]),_:1}),l(g,{label:"详情","min-width":"200",prop:"detail"}),l(g,{label:"时间",width:"100"},{default:a(({row:r})=>[_(o(H(r.timestamp)),1)]),_:1})]),_:1},8,["data"]),m.value.total>R.value.length?(i(),c("div",ut,[e("span",null,"显示前 "+o(R.value.length)+" 条，共 "+o(m.value.total)+" 条",1),l(b,{text:"",type:"primary",onClick:$},{default:a(()=>[...s[41]||(s[41]=[_("查看全部并下载",-1)])]),_:1})])):p("",!0)])):m.value.total===0?(i(),c("div",ct,[l(u,null,{default:a(()=>[l(Es)]),_:1}),s[42]||(s[42]=e("span",null,"暂无异常Key",-1))])):p("",!0)])):p("",!0),e("div",_t,[e("div",vt,[e("h3",null,[l(u,null,{default:a(()=>[l(Bs)]),_:1}),s[43]||(s[43]=_(" 任务日志",-1))]),e("div",pt,[l(q,{modelValue:S.value,"onUpdate:modelValue":s[2]||(s[2]=r=>S.value=r),placeholder:"日志级别",size:"small",style:{width:"100px"},clearable:""},{default:a(()=>[l(C,{label:"DEBUG",value:"DEBUG"}),l(C,{label:"INFO",value:"INFO"}),l(C,{label:"WARN",value:"WARN"}),l(C,{label:"ERROR",value:"ERROR"})]),_:1},8,["modelValue"]),l(b,{size:"small",onClick:B},{default:a(()=>[l(u,null,{default:a(()=>[l(Q)]),_:1}),s[44]||(s[44]=_(" 刷新 ",-1))]),_:1})])]),e("div",{class:"logs-container",ref_key:"logsContainer",ref:cs},[V.value.length===0?(i(),c("div",ft," 暂无日志 ")):p("",!0),(i(!0),c(N,null,z(V.value,r=>{var K,is;return i(),c("div",{key:r.id,class:D(["log-entry",(K=r.level)==null?void 0:K.toLowerCase()])},[e("span",mt,o(H(r.timestamp)),1),e("span",{class:D(["log-level",(is=r.level)==null?void 0:is.toLowerCase()])},o(r.level),3),e("span",yt,o(r.message),1),r.fields?(i(),c("span",gt,o(ys(r.fields)),1)):p("",!0)],2)}),128))],512)])])):(i(),c("div",kt,[l(u,{class:"loading-icon"},{default:a(()=>[l(Is)]),_:1}),s[45]||(s[45]=e("span",null,"加载中...",-1))]))}}},Ct=Ns(ht,[["__scopeId","data-v-c756437a"]]);export{Ct as default};
