import{_ as Q,l as W,o as X,a as Z,b as i,c as p,d as o,e as a,w as l,f as _,t as d,m as B,h as ee,n as te,g as w,p as se,i as f,j as n,k as v,q as ae,s as le,E as c,v as oe,u as ne,x as re}from"./index-C5Ql7TWZ.js";const ie={class:"tasks-page"},ce={class:"page-header"},de={class:"filter-bar"},ue={class:"tasks-list"},pe={class:"task-name-cell"},_e={class:"name"},me=["onClick"],ge={key:0,class:"progress-cell"},ve={class:"progress-bar"},fe={class:"progress-text"},ye={key:1,class:"no-progress"},ke={key:0},be={key:1},he={key:0},Ce={key:1},xe={class:"pagination"},Te={__name:"Tasks",setup(ze){const M=ne(),F=re(),V=v([]),$=v(0),h=v(1),C=v(20),y=v(""),k=v("");let x=null;W(()=>F.query.status,e=>{k.value=e||"",r()},{immediate:!0});const R=oe(()=>{let e=V.value;return y.value&&(e=e.filter(t=>t.name.toLowerCase().includes(y.value.toLowerCase()))),e}),r=async()=>{try{const e=await f.getTasks({page:h.value,size:C.value,status:k.value});V.value=e.items||[],$.value=e.total||0}catch(e){console.error("Fetch tasks failed:",e)}},D=async e=>{try{await f.startTask(e),c.success("任务已启动"),r()}catch{c.error("启动失败")}},E=async e=>{try{await f.pauseTask(e),c.success("任务已暂停"),r()}catch{c.error("暂停失败")}},I=async e=>{try{await f.resumeTask(e),c.success("任务已恢复"),r()}catch{c.error("恢复失败")}},N=async e=>{try{await le.confirm(`确定要删除任务 "${e.name}" 吗？此操作不可恢复。`,"删除确认",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),await f.deleteTask(e.id),c.success("任务已删除"),r()}catch(t){t!=="cancel"&&c.error("删除失败")}},P=e=>{M.push(`/tasks/${e.id}`)},U=e=>({pending:"待启动",running:"运行中",paused:"已暂停",completed:"已完成",failed:"失败"})[e]||e,Y=({row:e})=>`row-${e.status}`,T=e=>e>=1e9?(e/1e9).toFixed(1)+"B":e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString(),j=e=>ae(e).format("YYYY-MM-DD HH:mm:ss"),q=e=>{if(navigator.clipboard&&window.isSecureContext)return navigator.clipboard.writeText(e);const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();try{return document.execCommand("copy"),Promise.resolve()}catch(z){return Promise.reject(z)}finally{document.body.removeChild(t)}},H=async e=>{try{await q(e),c.success("任务ID已复制")}catch{c.error("复制失败")}};return X(()=>{r(),x=setInterval(r,1e4)}),Z(()=>{x&&clearInterval(x)}),(e,t)=>{const z=n("Plus"),S=n("el-icon"),m=n("el-button"),L=n("el-input"),g=n("el-option"),K=n("el-select"),A=n("Refresh"),G=n("el-tooltip"),u=n("el-table-column"),J=n("el-table"),O=n("el-pagination");return i(),p("div",ie,[o("div",ce,[t[7]||(t[7]=o("div",null,[o("h1",null,"迁移任务"),o("p",null,"管理所有数据迁移任务")],-1)),a(m,{type:"primary",onClick:t[0]||(t[0]=s=>e.$router.push("/create"))},{default:l(()=>[a(S,null,{default:l(()=>[a(z)]),_:1}),t[6]||(t[6]=_(" 创建任务 ",-1))]),_:1})]),o("div",de,[a(L,{modelValue:y.value,"onUpdate:modelValue":t[1]||(t[1]=s=>y.value=s),placeholder:"搜索任务名称...","prefix-icon":"Search",clearable:"",style:{width:"280px"}},null,8,["modelValue"]),a(K,{modelValue:k.value,"onUpdate:modelValue":t[2]||(t[2]=s=>k.value=s),placeholder:"全部状态",clearable:"",style:{width:"140px"}},{default:l(()=>[a(g,{label:"全部",value:""}),a(g,{label:"待启动",value:"pending"}),a(g,{label:"运行中",value:"running"}),a(g,{label:"已暂停",value:"paused"}),a(g,{label:"已完成",value:"completed"}),a(g,{label:"失败",value:"failed"})]),_:1},8,["modelValue"]),a(m,{onClick:r},{default:l(()=>[a(S,null,{default:l(()=>[a(A)]),_:1}),t[8]||(t[8]=_(" 刷新 ",-1))]),_:1})]),o("div",ue,[a(J,{data:R.value,style:{width:"100%"},"row-class-name":Y,onRowClick:P},{default:l(()=>[a(u,{label:"任务名称","min-width":"200"},{default:l(({row:s})=>[o("div",pe,[o("span",_e,d(s.name),1),a(G,{content:s.id,placement:"top"},{default:l(()=>[o("span",{class:"id",onClick:B(b=>H(s.id),["stop"])},d(s.id),9,me)]),_:2},1032,["content"])])]),_:1}),a(u,{label:"状态",width:"120"},{default:l(({row:s})=>[o("span",{class:ee(["status-tag",s.status])},d(U(s.status)),3)]),_:1}),a(u,{label:"进度","min-width":"200"},{default:l(({row:s})=>[s.progress?(i(),p("div",ge,[o("div",ve,[o("div",{class:"progress-inner",style:te({width:(s.progress.percentage||0)+"%"})},null,4)]),o("span",fe,d((s.progress.percentage||0).toFixed(1))+"%",1)])):(i(),p("span",ye,"-"))]),_:1}),a(u,{label:"迁移数据",width:"160"},{default:l(({row:s})=>[s.progress?(i(),p("span",ke,d(T(s.progress.keys_migrated||s.progress.migrated_keys||0))+" / "+d(T(s.progress.keys_total||s.progress.total_keys||0)),1)):(i(),p("span",be,"-"))]),_:1}),a(u,{label:"速度",width:"120"},{default:l(({row:s})=>[s.progress&&(s.progress.speed||s.progress.current_speed)?(i(),p("span",he,d(T(s.progress.speed||s.progress.current_speed))+"/s ",1)):(i(),p("span",Ce,"-"))]),_:1}),a(u,{label:"创建时间",width:"180"},{default:l(({row:s})=>[_(d(j(s.created_at)),1)]),_:1}),a(u,{label:"操作",width:"200",fixed:"right"},{default:l(({row:s})=>[o("div",{class:"actions",onClick:t[3]||(t[3]=B(()=>{},["stop"]))},[s.status==="pending"?(i(),w(m,{key:0,size:"small",type:"primary",onClick:b=>D(s.id)},{default:l(()=>[...t[9]||(t[9]=[_("启动",-1)])]),_:1},8,["onClick"])):s.status==="running"?(i(),w(m,{key:1,size:"small",onClick:b=>E(s.id)},{default:l(()=>[...t[10]||(t[10]=[_("暂停",-1)])]),_:1},8,["onClick"])):s.status==="paused"?(i(),w(m,{key:2,size:"small",type:"primary",onClick:b=>I(s.id)},{default:l(()=>[...t[11]||(t[11]=[_("恢复",-1)])]),_:1},8,["onClick"])):se("",!0),a(m,{size:"small",type:"danger",onClick:b=>N(s)},{default:l(()=>[...t[12]||(t[12]=[_("删除",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"]),o("div",xe,[a(O,{"current-page":h.value,"onUpdate:currentPage":t[4]||(t[4]=s=>h.value=s),"page-size":C.value,"onUpdate:pageSize":t[5]||(t[5]=s=>C.value=s),total:$.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",onSizeChange:r,onCurrentChange:r},null,8,["current-page","page-size","total"])])])])}}},Ve=Q(Te,[["__scopeId","data-v-d50b346e"]]);export{Ve as default};
